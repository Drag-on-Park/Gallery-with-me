{% extends 'base.html' %}
{% load static %}

<!--
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Bona+Nova+SC:ital,wght@0,400;0,700;1,400&display=swap"
	rel="stylesheet"> -->
<link rel="stylesheet" href="https://rawgit.com/enyo/dropzone/master/dist/dropzone.css" />
<script src="https://rawgit.com/enyo/dropzone/master/dist/dropzone.js"></script>

{% block extra-style %}
<!-- style-start -->
<style>	
	.img-container{
		padding-top: 160px;
		padding-inline: 10rem;
		display: flex;
		justify-content: center;
		width: 100%;
	}
	.clsf-header {
		max-width: 50%;
		flex-basis: 50%;
		display: flex;
		flex-direction: column;
	}
	.clsf-header .clsf-title{
		display: flex;
		flex-direction: column;
		justify-content: center; /* 세로 가운데 정렬 */

	}
	.clsf-header p{
		display: flex;
		justify-content: end;
		margin-top: 2rem;
		font-size: 21px;
		font-weight: 400;

	}
	.dropzone {
		position: relative;
		display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;

        margin: 0 20px;
        width: 100%;
		max-width: 600px;
        margin: 1%;
        border: 2px dashed #3498db !important;
        /* border-radius: 5px; */
        -webkit-transition: .2s;
        transition: .2s;
    }

	.dz-message.needsclick{
		
		margin: 3rem 5rem;
	}
	.dz-message.needsclick .text{
		white-space: nowrap;
		display: flex;
		align-items: center;
	}

    .dz-message.needsclick i {
    font-size: 150px;
    display: block;
    margin: auto;
    opacity: .6;
    margin-bottom: 15px;
    }
	/* X 버튼 스타일 */
	.delete-btn {
		position: absolute;
		top: 5px;
		right: 5px;
		width: 25px;
		height: 25px;
		background: #373634;
		color: white;
		border: none;
		border-radius: 50%;
		display: flex;
		justify-content: center;
		align-items: center;
		cursor: pointer;
		z-index: 10;
		opacity: 0.8;
	}

	.delete-btn:hover {
		background-color: rgb(90, 129, 151);
	}

	.img-preview {
		position: relative; /* 부모 요소에 relative 추가 */
		max-width: 150px; /* 이미지 크기를 50%로 설정 */
		max-height: 200px;
		margin: 10px;
		display: flex;
    	justify-content: center; /* 이미지 중앙 정렬 */
    	align-items: center; /* 이미지 중앙 정렬 */
		margin: 10px;
	}

	.img-preview img {
		width: 100%; /* 이미지 크기를 부모 컨테이너 크기에 맞게 조정 */
		height: auto;
		border-radius: 5px;
	}

	.upload-container{
		display: flex;
    	justify-content: center; /* 수평 중앙 정렬 */
    	flex-direction: column;
    	align-items: center;
		margin: 0 10rem;
		text-align: center;
	}
	#result-container{
		margin-left: 2rem;
		display: flex;
		
	}
	.clsf-title{
		font-size: 2rem;
		font-weight: 700;
		font-family: "Bona Nova SC", serif;
		font-style: normal;	
	}

	.clsf-submit-btn{
		margin-bottom: 2rem;	
	}
	.clsf-submit-btn:hover{
		background:#F0BA32;
	}

</style>
<!-- style-end -->

{% endblock %}

{% block content %}
<!-- 메인화면 -->
<div id="MainCarousel" class="carousel slide" data-bs-ride="carousel">
	<div class="carousel-indicators">
		<button type="button" data-bs-target="#MainCarousel" data-bs-slide-to="0" class="active" aria-current="true"
			aria-label="Slide 1"></button>
		<button type="button" data-bs-target="#MainCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
	</div>
	<div class="carousel-inner">
		<div class="carousel-item active ">
			<img src="{% static 'sample_images/흑백 갤러리(수정).jpg' %}" class="d-block w-100">
			<div class="carousel-caption d-none d-md-block ">
				<h3 class="carousel-title-description">함께 시작하는 첫 여정</h3>
				<h1 class="carousel-title">Gallery with Me</h1>
				<p class="carousel-title-description" style="font-size: 25px; font-weight: 300;">미술대학 졸업작품 중개 플랫폼</p>
				<a href="/artwork/artwork_list" class="btn btn-dark active carousel-btn" role="button">Artworks로 이동</a>
			</div>
		</div>
		<div class="carousel-item">
			<img src="{% static 'sample_images/사람들(수정).jpg' %}" class="d-block w-100">
			<div class="carousel-caption d-none d-md-block ">
				<h3 class="carousel-title-description">더 널리, 더 많은 사람들과 같이</h3>
				<h1 class="carousel-title">Gallery with Me</h1>
				<a href="/exhibit" class="btn btn-dark active carousel-btn" role="button">Exhibition으로 이동</a>
			</div>
		</div>
	</div>
</div>
<!-- 메인화면end -->

<!-- 카테고리 -->
<div class="container-fluid">
	<div class="row">
		<div class="col-4 card card-cate p-0 border-0 rounded-0">
			<a href="/artwork/artwork_list">
			<img src="{% static 'sample_images/아트워크.jpg' %}" class="card-img rounded-0" alt="...">
			<div class="card-img-overlay d-flex flex-column justify-content-center text-center">
				<h5 class="card-title">Artworks</h5>
			</div>
			</a>
		</div>
		<div class="col-4 card card-cate p-0 border-0 rounded-0">
			<a href="/board">
			<img src="{% static 'sample_images/커뮤니티.jpg' %}" class="card-img rounded-0" alt="...">
			<div class="card-img-overlay d-flex flex-column justify-content-center text-center">
				<h5 class="card-title">Community</h5>
			</div>
			</a>
		</div>
		<div class="col-4 card card-cate p-0 border-0 rounded-0">
			<a href="/exhibit/">
			<img src="{% static 'sample_images/나침반.jpg' %}" class="card-img rounded-0" alt="...">
			<div class="card-img-overlay d-flex flex-column justify-content-center text-center">
				<h5 class="card-title">Exhibition Map</h5>
			</div>
			</a>
		</div>
	</div>
</div>
<!-- 카테고리end -->

<!-- 이미지가 바이러스 >> 검증로직 필요 -->
<!-- Jpg, Jpeg Png Gif 등 -->
<!-- 이미지 분류기(비로그인) -->

<div class="image-classifier img-container">
	<div class="clsf-header">
		<h2 class="clsf-title">Artwork similarity classifier</h2>
		<p>이 AI 기반 이미지 분류 기능은 10만여 개의 작품을 학습한 모델을 통해 업로드 된 작품 이미지를 분석하여 화가, 예술 스타일, 장르, 시대를 예측해줍니다.</p>

	</div>

    <div class="upload-container">
		<div id="dropzone">
			<form action="http://localhost:8900/predict/" id="upload-form" class="dropzone needsclick" >
				{% csrf_token%}
				<div class="dz-message needsclick">
					<i class="fa-regular fa-image"></i>
					<div class="text">
						<span>👉&nbsp;&nbsp;</span>
						<span>
						여기에 파일을 끌어다 놓거나<br>클릭하여 업로드하세요.
						</span>
						<span>&nbsp;&nbsp;👈</span>
					</div>
				</div>
				<button type="submit" class="btn btn-outlne-secondary clsf-submit-btn" id="submit-btn" style="border: none;"><i class="fa-solid fa-play"></i></button>
			</form>
		</div>
    </div>

    <div id="result-container" style="display: none;">
        <div class="result-item"><strong>화가:</strong> <span id="artist-result"></span></div>
        <div class="result-item"><strong>스타일:</strong> <span id="style-result"></span></div>
        <div class="result-item"><strong>장르:</strong> <span id="genre-result"></span></div>
        <div class="result-item"><strong>시대:</strong> <span id="period-result"></span></div>
    </div>

    
</div>


<!-- 이미지 분류기end -->


<!-- 이미지 분류기(로그인) -->

<!-- 이미지 분류기end -->
<!-- 로그인했을때만 -->
{% if login_user %}

<!-- 작품추천 -->
<div class="container-rcmd">
	<div class="rcmd-head">
		<h2 class="rcmd-title">Artwork that you might like..</h2>
			<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="gray" class="bi bi-arrow-clockwise"
				viewBox="0 0 16 16">
				<path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z" />
				<path
					d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466" />
			</svg>
	</div>
	<div class="rcmd-content">
		<div class="rcmd-img">
			<img src="https://picsum.photos/400/600" alt="">
		</div>
		<div class="rcmd-text">
			<h2>Artwork Title</h2>
			<h3>John Doe</h3>
			<h3>1,000,000₩</h3>
					<p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut
						labore et
						dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut
						aliquip ex
						ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum
						dolore eu fugiat
						nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia
						deserunt mollit
						anim id est laborum.</p>
					<p>No one shall be held in slavery or servitude; slavery and the slave trade shall be prohibited in
						all their
						forms.</p>
					<a href="">See Details</a>
		</div>
	</div>
</div>
<!-- 작품추천end -->
{% endif %}
<!-- 이미지 분류기 API연결 -->
<script>
	document.addEventListener("DOMContentLoaded", function () {
		const dropzone = document.getElementById("dropzone");
		const form = document.getElementById("upload-form");
		const resultContainer = document.getElementById("result-container");
		const maxFileSize = 10 * 1024 * 1024; // 10MB (최대 파일 크기)
		let uploadedFile = null;

		// 드래그 앤 드롭 기능
		["dragover", "dragleave", "drop"].forEach(event => {
			dropzone.addEventListener(event, (e) => {
				e.preventDefault();
				dropzone.classList.toggle("drag-over", event === "dragover");
				if (event === "drop" && e.dataTransfer.files.length > 0) handleFile(e.dataTransfer.files[0]);
			});
		});

		// 클릭하여 파일 업로드 기능
		dropzone.addEventListener("click", () => {
			// 클릭 시 form에서 이미지를 업로드했으면, 클릭 이벤트를 무시
			if (uploadedFile) return;

			const fileInput = document.createElement("input");
			fileInput.type = "file";
			fileInput.accept = "image/*";
			fileInput.onchange = (e) => handleFile(e.target.files[0]);
			fileInput.click();
		});

		// 파일 처리
		function handleFile(file) {
			if (!file.type.startsWith("image/")) return alert("이미지 파일만 업로드 가능합니다.");
			if (file.size > maxFileSize) return alert("파일 용량은 10MB 이하여야 합니다.");

			uploadedFile = file; // 업로드된 파일 저장

			// 기존 안내문구와 아이콘을 썸네일 이미지로 교체
			updateDropzoneContent(file);
		}

		// Dropzone 내 안내문구와 아이콘을 썸네일로 업데이트
		function updateDropzoneContent(file) {
			const imgPreview = document.createElement("div");
			imgPreview.classList.add("img-preview");

			const imgElement = document.createElement("img");
			imgElement.src = URL.createObjectURL(file);
			imgPreview.appendChild(imgElement);

			const deleteBtn = document.createElement("button");
			deleteBtn.classList.add("delete-btn");
			deleteBtn.innerHTML = "&times;";
			deleteBtn.onclick = removeFile;
			imgPreview.appendChild(deleteBtn);

			// 기존의 dz-message를 썸네일로 교체
			const messageElement = dropzone.querySelector(".dz-message");
			messageElement.innerHTML = ""; // 기존 아이콘과 텍스트 제거
			messageElement.appendChild(imgPreview);
		}

		// 파일 제거 함수 (썸네일을 원래 안내문구와 아이콘으로 되돌림)
		function removeFile() {
			uploadedFile = null;
			const messageElement = dropzone.querySelector(".dz-message");
			messageElement.innerHTML = `
				<i class="fa-regular fa-image"></i>
				<div class="text">
					<span>👉&nbsp;&nbsp;</span>
					<span>여기에 파일을 끌어다 놓거나<br>클릭하여 업로드하세요.</span>
					<span>&nbsp;&nbsp;👈</span>
				</div>
			`;
		}

		// 폼 제출 시 이미지 전송 및 결과 표시
		form.addEventListener("submit", async (e) => {
			e.preventDefault();
			if (!uploadedFile) return alert("이미지를 업로드해 주세요.");

			const formData = new FormData();
			formData.append("file", uploadedFile);

			try {
				const response = await fetch('http://localhost:8900/predict/', {
					method: 'POST',
					body: formData,
					mode: 'cors'
				});
				const data = await response.json();

				// 결과를 화면에 표시
				displayResults(data);
			} catch (error) {
				console.error("Error:", error);
				alert("이미지 분석 중 오류가 발생했습니다. 다시 시도해주세요.");
			}
		});

		// 결과 표시 함수
		function displayResults(data) {
			document.getElementById('artist-result').textContent = Object.entries(data.artist)[0].join(': ');
			document.getElementById('style-result').textContent = Object.entries(data.style)[0].join(': ');
			document.getElementById('genre-result').textContent = Object.entries(data.genre)[0].join(': ');
			document.getElementById('period-result').textContent = Object.entries(data.period)[0].join(': ');
			resultContainer.style.display = 'block';
		}
	});

</script>

{% endblock %}